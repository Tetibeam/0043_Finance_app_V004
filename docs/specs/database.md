# データベース設計ドキュメント

## 1. 概要

このデータベースは、個人のポートフォリオ管理アプリで使用するデータを管理します。

**データベースエンジン**: PostgreSQL（本番環境）、SQLite（開発環境）
**ファイル名**:

- PostgreSQL: `finance`（データベース名）
- SQLite: `finance.db`（開発用）

**主な用途**:

- 資産データの保存と分析
- 収支データの管理
- 目標値の設定と追跡

---

## 2. スキーマ構成

### 2.1 テーブル一覧

| テーブル名         | 説明                       | 主なカラム                                                         |
| ------------------ | -------------------------- | ------------------------------------------------------------------ |
| `asset`            | 資産データ（銘柄レベル）   | date, 資産タイプ, 資産サブタイプ, 資産名, 資産額, トータルリターン |
| `balance`          | 収支データ                 | date, 収支タイプ, 収支カテゴリー, 金額, 目標                       |
| `target`           | 目標値データ               | date, 資産額, トータルリターン                                     |
| `target_parameter` | 目標設定のためのパラメータ | 収支項目, 繰り返し設定, 開始日,終了日,特定日                       |

### 2.2 詳細スキーマ

#### `asset` テーブル

日次の資産データを銘柄レベルで保存します。

| カラム名         | データ型      | 説明               | 例                         |
| ---------------- | ------------- | ------------------ | -------------------------- |
| date             | TEXT/DATETIME | 日付               | 2024-01-01                 |
| 資産タイプ       | TEXT          | 資産の大分類       | 安全資産、リスク資産、負債 |
| 資産カテゴリー   | TEXT          | 資産の中分類       | 固定資産、流動資産         |
| 資産サブタイプ   | TEXT          | 資産の小分類       | 国内株式, 投資信託         |
| 資産名           | TEXT          | 銘柄名             | トヨタ自動車, Apple Inc.   |
| 金融機関口座     | TEXT          | 銀行口座           | みずほ銀行                 |
| 資産額           | NUMERIC       | 評価額（円）       | 1000000                    |
| トータルリターン | NUMERIC       | 累積損益（円）     | 150000                     |
| 含み損益         | NUMERIC       | 含み損益（円）     | 150000                     |
| 実現損益         | NUMERIC       | 確定損益（円）     | 150000                     |
| 取得価格         | NUMERIC       | 取得合計価格（円） | 150000                     |
| last_updated     | TIMESTAMP     | 最終更新日時       | 2024-01-01 10:00:00        |

**インデックス**: `(date)`

#### `balance` テーブル

日次の収支データを保存します。

| カラム名       | データ型      | 説明                 | 例         |
| -------------- | ------------- | -------------------- | ---------- |
| date           | TEXT/DATETIME | 日付                 | 2024-01-01 |
| 収支タイプ     | TEXT          | 一般収支 or 特別収支   | 一般収支   |
| 収支カテゴリー | TEXT          | 収入 or 支出          | 収入       |
| 金額           | NUMERIC       | 金額（円）            | 300000     |
| 目標           | NUMERIC       | 目標金額（円）         | 320000     |
| last_updated   | TIMESTAMP    | 最終更新日時           | 2024-01-01 10:00:00  |

**インデックス**: `(date)`

#### `target` テーブル

日次の目標値データを保存します。

| カラム名         | データ型      | 説明                       | 例         |
| ---------------- | ------------- | -------------------------- | ---------- |
| date             | TEXT/DATETIME | 日付                       | 2024-01-01 |
| 資産タイプ        | TEXT          | 資産の大分類                | 安全資産、リスク資産、負債 |
| 資産額           | NUMERIC       | 目標資産額（円）             | 50000000   |
| 資産配分率        | NUMERIC       | 安全/リスク資産の比率        | 0.25   |
| トータルリターン | NUMERIC       | 目標トータルリターン（円）     | 10000000   |
| 利回り          | NUMERIC       | 安全,リスク資産の年利回り      | 0.02   |
| last_updated   | TIMESTAMP    | 最終更新日時                    | 2024-01-01 10:00:00  |

**インデックス**: `(date)`

### 2.3 キャッシュ DB

キャッシュ DB は、UI 表示・分析用の集計データを保持します。マスター DB から定期的に集計・更新されます。

#### 2.3.1 テーブル一覧

| テーブル名                  | 説明                         | 主なカラム                                     |
| --------------------------- | ------------------------- | ---------------------------------------------- |
| `asset_cache_daily`         | 銘柄レベル日次キャッシュ    | date, 資産名, 資産額, トータルリターン         |
| `asset_cache_monthly`       | 銘柄レベル月次キャッシュ    | year_month, 資産名, 資産額, トータルリターン   |
| `asset_cache_yearly`        | 銘柄レベル年次キャッシュ    | year, 資産名, 資産額, トータルリターン         |
| `category_cache_daily`      | カテゴリレベル日次キャッシュ | date, カテゴリ, 資産額, トータルリターン       |
| `category_cache_monthly`    | カテゴリレベル月次キャッシュ | year_month, カテゴリ, 資産額, トータルリターン |
| `category_cache_yearly`     | カテゴリレベル年次キャッシュ | year, カテゴリ, 資産額, トータルリターン       |

#### 2.3.2 詳細スキーマ

| テーブル名                  | カラム名                                   |
| --------------------------- | ------------------------------------------ |
| `asset_cache_daily`         | `asset` テーブルに準ずる                   |
| `asset_cache_monthly`       | `asset` テーブルに準ずる                   |
| `asset_cache_yearly`        | `asset` テーブルに準ずる                   |
| `category_cache_daily`      | 「`category_cache` カラム名の説明」を参照  |
| `category_cache_monthly`    | 「`category_cache` カラム名の説明」を参照  |
| `category_cache_yearly`     | 「`category_cache` カラム名の説明」を参照  |

**`category_cache` カラム名の説明**:

カラム名命名規則: `財務種類_評価項目_フィルタータイプ_フィルター値_出力値`

| 項目名               | 説明                             | 例                                                               |
| :------------------- | :------------------------------- | :--------------------------------------------------------------- |
| **財務種類**         | 資産か収支かを示す               | `資産`, `収支`, 空`                                                   |
| **評価項目**         | 資産額かトータルリターンかを示す | `実績`, `目標`                                                   |
| **フィルタータイプ** | フィルターの種類を示す           | `資産タイプ`, `資産カテゴリー`, `資産サブタイプ`, `金融口座機関`, 空 |
| **フィルター値**     | フィルターの値を示す             | `安全資産`, `固定資産`, `国内株式`, `みずほ銀行`, 空                 |
| **出力値**           | 出力する値を示す                 | `資産額`, `トータルリターン`, `含み損益`, `実現損益`, `取得価格`, `進捗率`, `貯蓄率` |

**重複フィルターの場合**:
2組の「フィルタータイプ」と「フィルター値」を連結した名称にします。

例：`資産_実績_資産タイプ_安全資産_金融口座機関_みずほ銀行_資産額`

---

## 3. データ型設計

### 3.1 日付の扱い

**保存形式**:

- **PostgreSQL**: TIMESTAMP 型（`2024-10-01 00:00:00`）
- **SQLite**: DATETIME 型（`2024-10-01 00:00:00.000000`）

**読み込み時**:

- Pandas では `pd.to_datetime()`で自動的に datetime64 型に変換
- SQLAlchemy が各 DB 間の日付型の違いを吸収

**理由**:

- DATETIME/TIMESTAMP 型を使うことで、DB ネイティブの日付関数が使用可能
- 時刻情報を保持できる（現在は 00:00:00 だが将来の拡張に対応）
- Pandas との親和性が高い

### 3.2 数値データ

- **金額・評価額**: NUMERIC 型
- **精度**: 小数点以下 2 桁まで対応
- **NULL 処理**: 0 または欠損値として扱う

### 3.3 キャッシュ DB 設計思想

#### Long 型 vs Wide 型

**銘柄レベルキャッシュ（Long 型）**:

- `asset_cache_daily/monthly/yearly`
- 各行が 1 銘柄の 1 日/1 ヶ月/1 年のデータ
- 新規銘柄追加時も列定義変更不要
- 柔軟性が高い

**カテゴリレベルキャッシュ（Wide 型も検討）**:

- `category_cache_daily/monthly/yearly`
- カテゴリ数が固定的な場合は Wide 型も選択肢
- 例：`year_month | 国内株式 | 外国株式 | 債券 | 現金`
- UI 表示が高速だが、カテゴリ追加時に列追加が必要

**将来対応**:

- NULL 許容列の追加で拡張性を確保
- 必要に応じてテーブル分割やパーティショニング

---

## 4. データフロー

### 4.1 初期化フロー

```
Parquetファイル（マスターデータ）
     │
     ▼
batch/init_master_db.py
     │
     ▼
finance.db (asset, balance, target) 作成
```

**実行コマンド**: `python batch/init_master_db.py`

### 4.2 更新フロー

```
CSVファイル（差分データ）
     │
     ▼
batch/update_master_db.py
     │
     ▼
finance.db 追記更新
```

**実行コマンド**: `python batch/update_master_db.py`

### 4.3 API 経由のデータ取得

```
UI/フロントエンド
     │
     ▼
Flask API (/api/dashboard/summary, /graphs)
     │
     ▼
app/utils/data_loader.py
     │
     ▼
finance.db (SQLAlchemy経由)
     │
     ▼
Pandas DataFrame
     │
     ▼
JSON レスポンス
```

### 4.4 キャッシュ DB 更新フロー（バッチ更新）

```
マスターDB更新完了
     │
     ▼
batch/update_cache_db.py起動
     │
     ▼
銘柄レベルキャッシュ更新
  ├─ asset_cache_daily
  ├─ asset_cache_monthly
  └─ asset_cache_yearly
     │
     ▼
カテゴリレベルキャッシュ更新
  ├─ category_cache_daily
  ├─ category_cache_monthly
  └─ category_cache_yearly
     │
     ▼
収支キャッシュ更新
  └─ transaction_cache_monthly
     │
     ▼
UI反映
```

**更新順序**:

1. マスター DB 更新（asset, balance, target）
2. 日次キャッシュ更新（daily）
3. 月次キャッシュ更新（monthly）
4. 年次キャッシュ更新（yearly）

**整合性保証**: 各ステップ完了後に次のステップを実行

### 4.5 キャッシュ DB 更新フロー（オンデマンド更新）

```
ユーザー操作（例：シミュレーション）
     │
     ▼
マスターDB部分更新
     │
     ▼
バックグラウンドジョブ起動（Celery等）
     │
     ▼
影響範囲のキャッシュのみ部分更新
     │
     ▼
更新完了通知
     │
     ▼
UI再描画
```

**特徴**:

- 非同期処理で応答性を確保
- 部分更新で処理コストを最小化
- 更新中は古いキャッシュを表示（eventual consistency）

---

## 5. 技術・運用

### 5.1 使用技術

- **DB エンジン**:
  - **本番環境**: PostgreSQL 14.x 以上
  - **開発環境**: SQLite 3.x
- **ORM ライブラリ**: SQLAlchemy
- **データ処理**: Pandas
- **API**: Flask
- **非同期処理**: Celery（キャッシュ DB 更新用、将来実装予定）

### 5.2 接続管理

- **接続方法**: SQLAlchemy エンジン経由
- **コンテキスト管理**: `with engine.connect()` / `with engine.begin()`
- **自動クローズ**: コンテキストマネージャで自動処理

### 5.3 バックアップ・メンテナンス

**PostgreSQL（本番環境）**:

- **バックアップ**: `pg_dump`で定期的にダンプファイル作成
- **整合性チェック**: `pg_checksums`、`VACUUM ANALYZE`
- **最適化**: `REINDEX`、`VACUUM FULL`（必要に応じて）

**SQLite（開発環境）**:

- **バックアップ**: 定期的に `database/finance.db`をコピー
- **整合性チェック**: `PRAGMA integrity_check;`
- **最適化**: `VACUUM;`で不要領域を解放

---

## 6. データ整合性ルール

### 6.1 制約

- **日付形式**: ISO 8601 形式（YYYY-MM-DD）に統一
- **NULL 許容**: 基本的に NULL は許容せず、0 または空文字列を使用
- **重複データ**: 同一日付・同一銘柄の複数レコードは集計で対応

### 6.2 集計ルール

- **日次集計**: `GROUP BY date, 資産名`
- **月次集計**: `resample('ME').sum()`（Pandas でリサンプリング）
- **カテゴリ集計**: `pivot_table()`で多次元集計

### 6.3 キャッシュ DB 整合性ルール

- **依存関係**: キャッシュ DB はマスター DB に依存
- **更新順序**: マスター DB 更新 → キャッシュ DB 更新（必須）
- **部分更新**: 影響範囲を特定し、必要なキャッシュのみ更新
- **整合性チェック**: 定期的にマスター DB と突合
- **再構築**: 不整合検出時はキャッシュ DB 全体を再生成

---

## 7. 将来拡張

### 7.1 予定される機能拡張

- **新資産タイプの追加**: 仮想通貨、不動産など
- **シミュレーション機能**: 将来予測データの一時保存
- **マルチユーザー対応**: ユーザー ID カラムの追加

### 7.2 スケーラビリティ

- **データ増加対応**: PostgreSQL のパーティショニング機能活用
- **テーブル分割**: 年度ごとや資産タイプごとにパーティション分割
- **インメモリキャッシュ**: Redis で頻繁にアクセスするデータをキャッシュ
- **レプリケーション**: PostgreSQL の読み取りレプリカで負荷分散
- **開発環境**: SQLite で軽量に開発・テスト

### 7.3 キャッシュ DB 関連の拡張

- **新規集計軸の追加**: 地域別、セクター別などの新しいキャッシュテーブル
- **リアルタイム更新**: Celery/RQ での非同期キャッシュ更新
- **キャッシュ有効期限**: TTL（Time To Live）による自動無効化
- **マテリアライズドビュー**: PostgreSQL 移行時に Materialized View の活用
- **増分更新最適化**: 変更差分のみを検出して効率的に更新

---

## 8. トラブルシューティング

### 8.1 よくある問題

**問題**: データが表示されない
**原因**: データベースファイルが存在しない、またはテーブルが空
**解決**: `batch/init_master_db.py`を実行してデータベースを初期化

**問題**: 日付フォーマットエラー
**原因**: CSV ファイルの日付形式が不正
**解決**: CSV ファイルの日付列を `YYYY-MM-DD`形式に修正

**問題**: SQLAlchemy エラー
**原因**: データベースロックまたは接続エラー
**解決**: アプリケーションを再起動し、他のプロセスが DB にアクセスしていないか確認

---

## 9. 参考資料

- [PostgreSQL 公式ドキュメント](https://www.postgresql.org/docs/)
- [SQLite 公式ドキュメント](https://www.sqlite.org/docs.html)（開発環境用）
- [SQLAlchemy 公式ドキュメント](https://docs.sqlalchemy.org/)
- [Pandas 公式ドキュメント](https://pandas.pydata.org/docs/)
- [Celery 公式ドキュメント](https://docs.celeryproject.org/)（非同期処理用）

---

**最終更新**: 2025-11-28
**バージョン**: 1.0
**管理者**: Portfolio Command Center Team
